# Smart Moon Lamp на ESP32

Демонстрационный проект, показывающий управление адресной светодиодной лентой (WS2812B) при помощи ESP32. Устройство умеет:

- Подключаться к Wi-Fi при помощи **WiFiManager**  
- Предоставлять удобный **Web-интерфейс** с использованием AJAX  
- Поддерживать **дополнительную страницу** (`/color`) для выбора цвета (пример кнопок «Save» и «Ok»)  
- Менять **количество используемых светодиодов (numLEDs) «на лету»**  
- Выполнять **«сглаживание» переходов** между лунными фазами  
- Иметь **режимы анимации**: Луна (Moon), Огонь (Fire), Радуга (Rainbow), статичный цвет, цветовая температура (Kelvin) и градиент  

Проект может быть использован как основа для создания собственных «умных» ламп, ночников и декоративных панелей.

---

## Основные особенности

1. **WiFiManager**  
   - Упрощённая настройка Wi-Fi-сети через точку доступа ESP32.  
   - Если устройство не найдёт настроенную сеть, оно запускается в режиме AP и предлагает веб-интерфейс для ввода данных Wi-Fi.

2. **Web-интерфейс (AJAX)**  
   - Основная страница `/` с ползунками и выпадающими списками для настройки:  
     - Яркости  
     - Количества светодиодов/рядов  
     - Выбора анимации  
     - Параметров каждого эффекта (скорость «огня», «радуги», текущая фаза Луны и т.п.)  
   - Все изменения (почти) сразу же применяются без необходимости нажимать «Сохранить» – происходит фоновой запрос AJAX.

3. **Лунная анимация (Moon)**  
   - Режимы: «Реальное время» (MOON_REALTIME), «Ускоренная анимация» (MOON_ACCELERATED) и «Ручной выбор фазы» (MOON_MANUAL).  
   - Плавное смещение `moonPhaseCurrent → moonPhaseTarget` для красивого перехода.

4. **Другие анимации**  
   - **Fire (Огонь)** с настраиваемыми параметрами `cooling`, `sparking` и `fireSpeed`.  
   - **Rainbow (Радуга)** с параметром `rainbowSpeed`.  
   - **Static** (Статичный цвет) — выбор цвета через color picker.  
   - **Temperature (K)** — псевдореалистичный белый свет на основе цветовой температуры в Кельвинах (1000–15000K).  
   - **Gradient (Градиент)** — вертикальный переход между двумя цветами (top и bottom).

5. **Переключение питания (Power Toggle)**  
   - Есть возможность «выключить» подсветку (зажигаем все чёрным цветом), при этом Wi-Fi и сервер продолжают работать.

6. **Сохранение настроек**  
   - Параметры (количество светодиодов, яркость, текущая анимация, цвета и т.п.) сохраняются в **Preferences** (NVS), а часть — в EEPROM.  
   - Есть функция `resetAllSettings()`, обнуляющая и Preferences, и EEPROM, и WiFiManager.

7. **Обновление прошивки (OTA)**  
   - Возможность загрузить `.bin` или `.bin.gz` файл прошивки через веб-интерфейс (эндпоинт `/uploadfw`).

---

## Требования

- **Аппаратная платформа:** ESP32 (совместимая плата, например, DevKitC).  
- **Адресная лента:** WS2812B (или совместимые светодиоды) на выбранном пине (по умолчанию `LED_PIN = 18`).  
- **Arduino Core** для ESP32.  
- Библиотеки:  
  - [WiFiManager](https://github.com/tzapu/WiFiManager)  
  - [ESPAsyncWebServer](https://github.com/me-no-dev/ESPAsyncWebServer) (+ зависимые AsyncTCP)  
  - [FastLED](https://github.com/FastLED/FastLED)  
  - [Preferences.h] (стандартная библиотека ESP32)  
  - [EEPROM.h] (стандартная библиотека ESP32)  
  - [Update.h] (стандартная библиотека ESP32)

---

## Быстрый старт

0. **Склонируйте** репозиторий к себе:
   ```bash
   git clone https://github.com/FeelDiference/moonlamp.git
   
1. **Установите необходимые библиотеки**  
   Убедитесь, что в вашей среде разработки (Arduino IDE или PlatformIO) присутствуют все нужные библиотеки:  
   - **WiFiManager**  
   - **ESPAsyncWebServer** (+ AsyncTCP)  
   - **FastLED**  
   - **Preferences** (встроена в ESP32)  
   - **EEPROM** (встроена в ESP32)  
   - **Update** (встроена в ESP32)

2. **Откройте проект**  
   - Если используете Arduino IDE, откройте файл `main.ino` (или `src/main.cpp`) через меню **File → Open**.  
   - Если используете PlatformIO, откройте папку репозитория как проект.

3. **Скорректируйте настройки в коде (по необходимости)**  
   - Пин для ленты (`LED_PIN`, по умолчанию 18).  
   - Максимальное число светодиодов (`MAX_LEDS`, по умолчанию 215).  
   - Начальные значения яркости, количество рядов и т.д.

4. **Скомпилируйте и загрузите прошивку** на ESP32  
   - В Arduino IDE нажмите «Verify» (проверить), затем «Upload» (загрузить).  
   - В PlatformIO используйте команды `platformio run --target upload`.

5. **Подключитесь к Wi-Fi-менеджеру** при первом запуске  
   - После успешной прошивки и перезагрузки ESP32 должен развернуть точку доступа с именем `ESP32_Setup`.  
   - Подключитесь к ней со своего устройства (смартфон, ПК),  
   - Откройте любой браузер и перейдите на `192.168.4.1` (если не открылось само).  
   - Введите SSID и пароль вашей домашней сети Wi-Fi.

6. **Используйте полученный IP-адрес**  
   - После того как устройство подключится к вашей домашней сети, оно получит IP-адрес.  
   - Зайдите в браузере на этот IP-адрес, чтобы увидеть веб-интерфейс.

7. **Настройте эффекты и опции**  
   - На главной странице можно выбрать тип анимации, изменить яркость, задать количество светодиодов, выбрать цвета и т.д.  
   - Изменения сохраняются «на лету» и записываются в Preferences.

8. **Опционально: Обновите прошивку (OTA)**  
   - В веб-интерфейсе найдите раздел «Обновление прошивки».  
   - Выберите `.bin` или `.bin.gz` файл, нажмите «Upload» для прошивки «по воздуху».  

9. **Опционально: Сброс настроек**  
   - Перейдите по адресу `/resetDevice` или воспользуйтесь кнопкой «Сброс» (если она реализована в интерфейсе).  
   - Устройство очистит Wi-Fi-настройки, Preferences, EEPROM и перезапустится.

Теперь ваше устройство готово к работе!
